# WebSocketチャット機能のテストガイド

## ✅ 現在の状態

WebSocket接続は成功しています！以下のことが確認できました：

- ✅ サーバーへの接続成功（HTTP Status: 101 Switching Protocols）
- ✅ JWT認証が正常に動作
- ✅ メッセージの送信が正常に動作

## 📋 次のステップ：メッセージのブロードキャストをテスト

### 1. 複数のクライアントでテスト

**ターミナル1**（現在実行中）:
```bash
./test_ws_client -addr localhost:8080 -chat 1 -token "YOUR_TOKEN_1"
```

**ターミナル2**（新しく開く）:
```bash
./test_ws_client -addr localhost:8080 -chat 1 -token "YOUR_TOKEN_2"
```

**期待される動作:**
- ターミナル1でメッセージを送信すると、ターミナル2で受信される
- ターミナル2でメッセージを送信すると、ターミナル1で受信される
- メッセージがデータベースに保存される

### 2. メッセージ履歴の確認

接続時に、そのチャットルームの既存メッセージが自動的に送信されます。

### 3. サーバーログの確認

サーバー側のログで以下を確認できます：
- クライアントの接続/切断
- メッセージの受信とブロードキャスト
- データベースへの保存

## 🔍 トラブルシューティング

### メッセージが受信されない場合

1. **同じチャットIDで接続しているか確認**
   - 両方のクライアントが同じ`-chat`パラメータを使用しているか

2. **異なるユーザートークンを使用しているか確認**
   - 同じトークンでは、自分が送信したメッセージは自分に返ってきません（正常な動作）

3. **サーバーログを確認**
   - メッセージがブロードキャストされているか
   - データベースへの保存が成功しているか

4. **データベースを確認**
   ```sql
   SELECT * FROM messages WHERE chat_id = 1 ORDER BY sent_at DESC LIMIT 10;
   ```

## 📊 テストシナリオ

### シナリオ1: 基本的なメッセージ送受信
1. 2つのクライアントを同じチャットルームに接続
2. クライアント1からメッセージを送信
3. クライアント2でメッセージを受信することを確認

### シナリオ2: メッセージ履歴の取得
1. データベースに既存のメッセージがある状態で接続
2. 接続時にメッセージ履歴が送信されることを確認

### シナリオ3: 複数クライアントへのブロードキャスト
1. 3つ以上のクライアントを同じチャットルームに接続
2. 1つのクライアントからメッセージを送信
3. 他のすべてのクライアントでメッセージを受信することを確認

## 🎯 確認ポイント

- [ ] 接続が成功する
- [ ] メッセージを送信できる
- [ ] 他のクライアントからメッセージを受信できる
- [ ] メッセージがデータベースに保存される
- [ ] 接続時にメッセージ履歴が取得できる
- [ ] 切断が正常に動作する

